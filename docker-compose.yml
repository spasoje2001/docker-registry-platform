version: "3.8"

services:
    nginx:
      image: nginx:alpine
      ports:
        - "80:80"
      volumes:
        - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
        - static_volume:/app/staticfiles
      depends_on:
        - web
      restart: unless-stopped

    web:
      build: ./app
      command: >
        sh -c "python manage.py migrate &&
               python manage.py collectstatic --noinput &&
               python manage.py runserver 0.0.0.0:8000"
      volumes:
        - ./app:/app
        - static_volume:/app/staticfiles
        - logs_volume:/app/logs
      environment:
        - DEBUG=True
        - SECRET_KEY=dev-secret-key-change-in-production
        - DATABASE_URL=postgres://postgres:postgres@db:5432/dockerhub
        - REDIS_URL=redis://redis:6379/0
        - ELASTICSEARCH_URL=http://elasticsearch:9200
        - REGISTRY_URL=http://registry:5000
        - ALLOWED_HOSTS=localhost,127.0.0.1,0.0.0.0
      depends_on:
        db:
          condition: service_healthy
        redis:
          condition: service_started
      restart: unless-stopped

    db:
      image: postgres:15-alpine
      ports:
        - "5444:5432"
      volumes:
        - postgres_data:/var/lib/postgresql/data
      environment:
        - POSTGRES_DB=dockerhub
        - POSTGRES_USER=postgres
        - POSTGRES_PASSWORD=postgres
      healthcheck:
        test: [ "CMD-SHELL", "pg_isready -U postgres" ]
        interval: 5s
        timeout: 5s
        retries: 5
      restart: unless-stopped

    redis:
      image: redis:7-alpine
      volumes:
        - redis_data:/data
      restart: unless-stopped

    elasticsearch:
      image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
      environment:
        - discovery.type=single-node
        - xpack.security.enabled=false
        - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      volumes:
        - elasticsearch_data:/usr/share/elasticsearch/data
      ports:
        - "9200:9200"
      healthcheck:
        test: [ "CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1" ]
        interval: 30s
        timeout: 10s
        retries: 5
      restart: unless-stopped

    registry:
      image: registry:2
      ports:
        - "5000:5000"
      volumes:
        - registry_data:/var/lib/registry
      environment:
        - REGISTRY_STORAGE_DELETE_ENABLED=true
      restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  elasticsearch_data:
  registry_data:
  static_volume:
  logs_volume: