{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-9">
            <div class="card shadow-sm">
                <div class="d-flex justify-content-between card-header bg-white py-3">
                    <h3 class="mb-0">
                        <i class="bi bi-tag text-primary"></i>
                        {{ title }}
                    </h3>
                    {% if request.GET.from_profile %}
                        <a href="{% url 'repositories:detail' repository.owner.username repository.name %}{% if request.GET.from_profile %}?from_profile=1{% endif %}" 
                        class="btn btn-link text-decoration-none">
                            <i class="bi bi-arrow-left"></i> Go Back
                        </a>
                    {% elif repository.is_official %}
                        <a href="{% url 'repositories:detail_official' repository.name %}" class="btn btn-link text-decoration-none">
                            <i class="bi bi-arrow-left"></i> Go Back
                        </a>
                    {% else %}
                        <a href="{% url 'repositories:detail' repository.owner.username repository.name %}" class="btn btn-link text-decoration-none">
                            <i class="bi bi-arrow-left"></i> Go Back
                        </a>
                    {% endif %}
                </div>

                <div class="card-body p-4">
                    {% if not tag %}
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="flex-fill">
                                    <div class="progress" style="height: 4px;">
                                        <div class="progress-bar" id="formProgress" role="progressbar" style="width: 50%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mt-2">
                                <div class="text-center" style="flex: 1;">
                                    <div class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center" 
                                        style="width: 40px; height: 40px;" id="step1Badge">
                                        <i class="bi bi-1-circle-fill"></i>
                                    </div>
                                    <div class="small mt-1 fw-semibold" id="step1Text">Tag Details</div>
                                </div>
                                <div class="text-center" style="flex: 1;">
                                    <div class="rounded-circle bg-secondary text-white d-inline-flex align-items-center justify-content-center" 
                                        style="width: 40px; height: 40px;" id="step2Badge">
                                        <i class="bi bi-2-circle"></i>
                                    </div>
                                    <div class="small mt-1 text-muted" id="step2Text">Docker Commands</div>
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <form method="post" id="tagForm">
                        {% csrf_token %}

                        <div id="step1" class="form-step">
                            {% if not tag %}
                                <h5 class="mb-3">
                                    <i class="bi bi-info-circle text-primary"></i> Step 1: Enter Tag Information
                                </h5>
                            {% endif %}

                            <div class="mb-4">
                                <label for="{{ form.name.id_for_label }}" class="form-label fw-semibold">
                                    Name <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-tag"></i>
                                    </span>
                                    {{ form.name }}
                                </div>
                                {% if form.name.errors %}
                                    <div class="text-danger mt-2">
                                        {{ form.name.errors }}
                                    </div>
                                {% endif %}
                                {% if not tag %}
                                    <div class="form-text">
                                        <i class="bi bi-info-circle"></i>
                                        Alphanumeric with dots, hyphens, and underscores (e.g., v1.0.0, latest)
                                    </div>
                                {% endif %}
                            </div>

                            {% if tag %}
                                <div class="mb-4">
                                    <label class="form-label fw-semibold">
                                        Digest
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="bi bi-fingerprint"></i>
                                        </span>
                                        <input type="text"
                                            class="form-control font-monospace"
                                            value="{{ manifest.digest }}" 
                                            readonly>
                                    </div>
                                </div>

                                <div class="row g-3 align-items-center mb-2">
                                    <div class="col-6 col-lg-3">
                                        <div>
                                            <small class="text-muted d-block">
                                                <i class="bi bi-cpu"></i> OS/Arch
                                            </small>
                                            <small>{{ manifest.os }}{% if manifest.arch %}/{{ manifest.arch }}{% endif %}</small>
                                        </div>
                                    </div>

                                    <div class="col-6 col-lg-3">
                                        <div>
                                            <small class="text-muted d-block">
                                                <i class="bi bi-hdd"></i> Size
                                            </small>
                                            <small>{{ manifest.compressed_size }}</small>
                                        </div>
                                    </div>

                                    <div class="col-6 col-lg-3">
                                        <div>
                                            <small class="text-muted d-block">
                                                <i class="bi bi-calendar-check"></i> Type
                                            </small>
                                            <small>{{ manifest.type }}</small>
                                        </div>
                                    </div>

                                    <div class="col-6 col-lg-3">
                                        <div>
                                            <small class="text-muted d-block">
                                                <i class="bi bi-calendar-plus"></i> Created
                                            </small>
                                            <small>{{ tag.created_at|date:"M d, Y" }}</small>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}

                            <div class="d-flex gap-2 pt-3 border-top">
                                {% if not tag %}
                                    <button type="button" class="btn btn-primary" id="nextBtn">
                                        Next <i class="bi bi-arrow-right"></i>
                                    </button>
                                {% else %}
                                    <a href="{% url 'repositories:tag_delete' repository.owner.username repository.name tag.name manifest.digest %}" 
                                        class="btn btn-sm btn-danger">
                                        <i class="bi bi-trash"></i> Delete
                                    </a>
                                {% endif %}
                            </div>
                        </div>

                        {% if not tag %}
                            <div id="step2" class="form-step d-none">
                                <h5 class="mb-3">
                                    <i class="bi bi-terminal text-primary"></i> Step 2: Docker Push Commands
                                </h5>

                                <div class="mb-4">
                                    <label class="form-label fw-semibold">
                                        <i class="bi bi-1-circle"></i> Tag your Docker image
                                    </label>
                                    <div class="input-group">
                                        <input type="text" class="form-control font-monospace" id="tagCommand" readonly>
                                        <button class="btn btn-outline-secondary" type="button" onclick="copyCmd('tagCommand')">
                                            <i class="bi bi-clipboard"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">
                                        Tag your local image with the repository name and tag
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label fw-semibold">
                                        <i class="bi bi-2-circle"></i> Push the tagged image
                                    </label>
                                    <div class="input-group">
                                        <input type="text" class="form-control font-monospace" id="pushCommand" readonly>
                                        <button class="btn btn-outline-secondary" type="button" onclick="copyCmd('pushCommand')">
                                            <i class="bi bi-clipboard"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">
                                        Push the tagged image to the registry
                                    </div>
                                </div>

                                <div class="d-flex gap-2 pt-3 border-top mt-4">
                                    <button type="button" class="btn btn-outline-secondary" id="prevBtn">
                                        <i class="bi bi-arrow-left"></i> Previous
                                    </button>
                                    <button type="submit" class="btn btn-success">
                                        <i class="bi bi-plus-circle"></i> Create
                                    </button>
                                </div>
                            </div>
                        {% endif %}
                    </form>
                </div>
            </div>

            <div class="alert alert-info mt-4" role="alert">
                <i class="bi bi-lightbulb"></i>
                <strong>Tip:</strong> Tag names should follow semantic versioning (e.g., v1.0.0) or use common conventions like "latest", "dev", "staging".
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const nextBtn = document.getElementById('nextBtn');
    const prevBtn = document.getElementById('prevBtn');
    const formProgress = document.getElementById('formProgress');
    const step1Badge = document.getElementById('step1Badge');
    const step2Badge = document.getElementById('step2Badge');
    const step1Text = document.getElementById('step1Text');
    const step2Text = document.getElementById('step2Text');

    const tagNameInput = document.getElementById('{{ form.name.id_for_label }}');
    const registryUrl = window.location.hostname + ':5000';
    const repositoryPath = '{{repository.name}}';

    nextBtn.addEventListener('click', function() {
        const tagName = tagNameInput.value.trim();
        if (!tagName) {
            alert('Please enter a tag name');
            return;
        }

        updateDockerCommands(tagName);

        step1.classList.add('d-none');
        step2.classList.remove('d-none');

        formProgress.style.width = '100%';
        
        step1Badge.classList.remove('bg-primary');
        step1Badge.classList.add('bg-success');
        step1Badge.innerHTML = '<i class="bi bi-check-circle-fill"></i>';
        step1Text.classList.add('text-success');
        
        step2Badge.classList.remove('bg-secondary');
        step2Badge.classList.add('bg-primary');
        step2Badge.innerHTML = '<i class="bi bi-2-circle-fill"></i>';
        step2Text.classList.remove('text-muted');
        step2Text.classList.add('fw-semibold');
    });

    prevBtn.addEventListener('click', function() {
        step2.classList.add('d-none');
        step1.classList.remove('d-none');

        formProgress.style.width = '50%';
        
        step1Badge.classList.remove('bg-success');
        step1Badge.classList.add('bg-primary');
        step1Badge.innerHTML = '<i class="bi bi-1-circle-fill"></i>';
        step1Text.classList.remove('text-success');
        
        step2Badge.classList.remove('bg-primary');
        step2Badge.classList.add('bg-secondary');
        step2Badge.innerHTML = '<i class="bi bi-2-circle"></i>';
        step2Text.classList.add('text-muted');
        step2Text.classList.remove('fw-semibold');
    });

    function updateDockerCommands(tagName) {
        const fullImageName = `${registryUrl}/${repositoryPath}:${tagName}`;
        
        const tagCommand = `docker tag ${repositoryPath}:${tagName} ${fullImageName}`;
        const pushCommand = `docker push ${fullImageName}`;
        
        document.getElementById('tagCommand').value = tagCommand;
        document.getElementById('pushCommand').value = pushCommand;
    }
});

function copyCmd(elementId) {
    const input = document.getElementById(elementId);
    input.select();
    navigator.clipboard.writeText(input.value).then(() => {
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i>';
        btn.classList.add('btn-success');
        btn.classList.remove('btn-outline-secondary');
        
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
        }, 2000);
    });
}
</script>

{% endblock %}