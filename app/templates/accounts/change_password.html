{% extends "base.html" %}

{% block title %}Change password{% endblock %}

{% block content %}
<div class="row justify-content-center mt-5">
    <div class="col-md-5">
        <div class="card shadow-sm">
            <div class="card-body p-4">

                <h3 class="mb-4 text-center">
                    <i class="bi bi-shield-lock"></i> Change password
                </h3>

                <form method="post">
                    {% csrf_token %}

                    <!-- OLD PASSWORD -->
                    <div class="mb-3">
                        <label class="form-label">Current password</label>
                        <div class="input-group">
                            <input
                                type="password"
                                id="old_password"
                                name="old_password"
                                class="form-control"
                                required
                            >
                            <button
                                class="btn btn-outline-secondary"
                                type="button"
                                onclick="togglePassword('old_password', this)"
                            >
                                <i class="bi bi-eye-slash"></i>
                            </button>
                        </div>
                    </div>

                    <!-- NEW PASSWORD -->
                    <div class="mb-3">
                        <label class="form-label">New password</label>
                        <div class="input-group">
                            <input
                                type="password"
                                id="new_password"
                                name="new_password1"
                                class="form-control"
                                required
                            >
                            <button
                                class="btn btn-outline-secondary"
                                type="button"
                                onclick="togglePassword('new_password', this)"
                            >
                                <i class="bi bi-eye-slash"></i>
                            </button>
                        </div>
                    </div>

                    <!-- CONFIRM PASSWORD -->
                    <div class="mb-4">
                        <label class="form-label">Confirm new password</label>
                        <div class="input-group">
                            <input
                                type="password"
                                id="confirm_password"
                                name="new_password2"
                                class="form-control"
                                required
                            >
                            <button
                                class="btn btn-outline-secondary"
                                type="button"
                                onclick="togglePassword('confirm_password', this)"
                            >
                                <i class="bi bi-eye-slash"></i>
                            </button>
                        </div>
                        <div
                            id="password-error"
                            class="text-danger small mt-2 d-none"
                        ></div>

                        <div class="card bg-light mb-4">
                            <div class="card-body p-3">
                                <h6 class="card-title mb-2">
                                    <i class="bi bi-info-circle me-1"></i>Password Requirements:
                                </h6>
                                <ul class="small mb-0 ps-3">
                                    <li>At least 8 characters long</li>
                                    <li>Cannot be too similar to your username</li>
                                    <li>Cannot be a commonly used password</li>
                                    <li>Cannot be entirely numeric</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- BUTTONS -->
                    <div class="d-grid gap-2">
                        <button
                            id="save-btn"
                            type="submit"
                            class="btn btn-primary"
                            disabled
                        >
                            Save changes
                        </button>
                        <a
                            href="{% url 'accounts:edit_profile' %}"
                            class="btn btn-outline-secondary"
                        >
                            Cancel
                        </a>
                    </div>
                </form>

            </div>
        </div>
    </div>
</div>

<script>
    const oldPassword = document.getElementById("old_password");
    const newPassword = document.getElementById("new_password");
    const confirmPassword = document.getElementById("confirm_password");
    const saveBtn = document.getElementById("save-btn");
    const errorBox = document.getElementById("password-error");

    const username = "{{ user.username|escapejs }}";

    function togglePassword(inputId, button) {
        const input = document.getElementById(inputId);
        const icon = button.querySelector("i");

        if (input.type === "password") {
            input.type = "text";
            icon.classList.replace("bi-eye-slash", "bi-eye");
        } else {
            input.type = "password";
            icon.classList.replace("bi-eye", "bi-eye-slash");
        }
    }

    function showError(message) {
        errorBox.textContent = message;
        errorBox.classList.remove("d-none");
        saveBtn.disabled = true;
    }

    function validatePasswords() {
        errorBox.classList.add("d-none");
        errorBox.textContent = "";

        if (!oldPassword.value || !newPassword.value || !confirmPassword.value) {
            showError("Current, new and confirm password must have value.");
            saveBtn.disabled = true;
            return;
        }

        if (newPassword.value !== confirmPassword.value) {
            showError("New password and confirmation do not match.");
            return;
        }

        if (newPassword.value === oldPassword.value) {
            showError("New password must be different from current password.");
            return;
        }

        if (newPassword.value.length < 8) {
            showError("New password must be at least 8 characters long.");
            return;
        }

        if (username && newPassword.value.toLowerCase().includes(username.toLowerCase())) {
            showError("New password cannot be too similar to your username.");
            return;
        }

        if (/^\d+$/.test(newPassword.value)) {
            showError("New password cannot be entirely numeric.");
            return;
        }

        saveBtn.disabled = false;
    }

    oldPassword.addEventListener("input", validatePasswords);
    newPassword.addEventListener("input", validatePasswords);
    confirmPassword.addEventListener("input", validatePasswords);

    // inicial check
    validatePasswords();
</script>
{% endblock %}
