{% extends "base.html" %}
{% block title %}Admin Panel - Users{% endblock %}

{% block content %}
<div class="container">

    <!-- URL template for JS -->
    <div id="badge-config"
         data-url-template="{% url 'accounts:update_badges' 0 %}">
    </div>

    <!-- Toast container -->
    <div class="toast-container position-fixed top-0 end-0 p-3"></div>

    <div class="d-flex align-items-center justify-content-between mb-3">
        <h2 class="h3 mb-0">
            <i class="bi bi-shield-lock text-primary me-2"></i>Admin Panel
        </h2>
    </div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-4" role="tablist">
        <li class="nav-item">
            <a class="nav-link {% if current_section == 'users' %}active{% endif %}"
               href="{% url 'accounts:admin_panel' %}?section=users">
                <i class="bi bi-people me-1"></i> User Management
            </a>
        </li>
        {% if is_super_admin %}
        <li class="nav-item">
            <a class="nav-link {% if current_section == 'admins' %}active{% endif %}"
               href="{% url 'accounts:admin_panel' %}?section=admins">
                <i class="bi bi-shield-check me-1"></i> Admin Management
            </a>
        </li>
        {% endif %}
    </ul>

    {% if current_section == 'users' %}
        {% include 'accounts/partials/user_management.html' %}
    {% elif current_section == 'admins' %}
        {% include 'accounts/partials/admin_management.html' %}
    {% endif %}

</div>

<script>
/* ---------------- CSRF ---------------- */
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

const csrftoken = getCookie("csrftoken");
const urlTemplate = document
    .getElementById("badge-config")
    .dataset.urlTemplate;

/* ---------------- Toast ---------------- */
function showToast(message, type = "success") {
    const container = document.querySelector(".toast-container");

    const toast = document.createElement("div");
    toast.className = `toast align-items-center text-bg-${type} border-0 show`;
    toast.setAttribute("role", "alert");

    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto"></button>
        </div>
    `;

    container.appendChild(toast);

    setTimeout(() => toast.remove(), 2000);
}

/* ---------------- Toggle logic ---------------- */
document.querySelectorAll(".badge-toggle").forEach(toggle => {
    toggle.addEventListener("change", async () => {
        const userId = toggle.dataset.userId;
        const badge = toggle.dataset.badge;
        const value = toggle.checked ? "1" : "0";
        const previous = !toggle.checked;

        const url = urlTemplate.replace("/0/", `/${userId}/`);

        try {
            const response = await fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": csrftoken
                },
                body: new URLSearchParams({ badge, value })
            });

            if (!response.ok) {
                toggle.checked = previous;
                showToast("Error saving changes", "danger");
                return;
            }

            showToast("Saved successfully âœ”");
        } catch (error) {
            toggle.checked = previous;
            showToast("Network error", "danger");
        }
    });
});
</script>
{% endblock %}
